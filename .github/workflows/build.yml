name: build
on: [push]

jobs:
  container-job:
    runs-on: ubuntu-latest

    # runs all of the steps inside the specified container rather than on the VM host.
    # Because of this the network configuration changes from host based network to a container network.
    container:
      image:  node:10.16-jessie

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_DATABASE: banned_history
          MYSQL_ROOT_PASSWORD: root_password
        ports:
        - 3306:3306
        # needed because the mysql container does not provide a healthcheck
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=10s --health-retries=10

    steps:
    - uses: actions/checkout@v2
      env:
        # use mysql for the host here because we have specified a container for the job.
        # If we were running the job on the VM this would be localhost
        MYSQL_HOST: mysql
        MYSQL_PORT: 3306
    - run: npm install
    - run: GITLAB_CI=true npm run init-db
    - run: GITLAB_CI=true npm run build
    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dist
        path: dist

